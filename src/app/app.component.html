<div class="app-container">
  <app-header></app-header>
  <div class="flex bg-gray-100 main-content">
  <!-- Sidebar -->
  <app-sidebar 
    [plantas]="plantas"
    [plantaActiva]="plantaActiva"
    [subnivelSeleccionado]="subnivelSeleccionado"
    (plantaActivaChange)="onPlantaActivaChange($event)"
    (toggleNivelEvent)="toggleNivel($event)"
    (seleccionarSubnivelEvent)="seleccionarSubnivel($event.nivelIndex, $event.subnivelIndex)"
    (editarNombrePlantaEvent)="onEditarNombrePlanta($event)">
  </app-sidebar>

  <!-- Ãrea contenido - Dashboard Grid -->
  <div class="flex-1 overflow-y-auto p-6 content-area" 
       [class.sidebar-collapsed]="!(sidebarVisible$ | async)">
    <div *ngIf="subnivelActual" class="w-full">
      <!-- TÃ­tulo del Subnivel -->
      <h2 class="text-3xl font-bold mb-6 text-gray-800">
        {{plantas[plantaActiva].nombre}} - {{subnivelActual.titulo || 'Subnivel ' + subnivelActual.id}}
      </h2>

      <!-- Botones de Acciones (Editar InformaciÃ³n y Agregar Contenido) -->
      <div class="mb-6 flex gap-4">
        <button (click)="abrirDialogoEditarInfo()" 
                mat-raised-button color="primary"
                class="flex items-center gap-2">
          <mat-icon>edit</mat-icon>
          Editar InformaciÃ³n
        </button>

        <button (click)="abrirDialogoAgregarContenido()" 
                mat-raised-button color="accent"
                class="flex items-center gap-2">
          <mat-icon>add</mat-icon>
          Agregar Contenido
        </button>

        <!-- BotÃ³n para crear collage (solo si hay suficientes imÃ¡genes) -->
        <button *ngIf="subnivelActual && subnivelActual.imagenes.length >= 2"
                (click)="iniciarCreacionCollage()"
                mat-raised-button color="warn"
                class="flex items-center gap-2">
          <mat-icon>collections</mat-icon>
          Collage
        </button>
      </div>

      <!-- Grid Dashboard -->
      <div class="dashboard-masonry">
        <!-- KPI Card (PequeÃ±a) -->
        <div *ngIf="subnivelActual.titulo" class="masonry-item masonry-item-small">
          <div class="card card-kpi">
            <h3>InformaciÃ³n</h3>
            <p>{{subnivelActual.titulo}}</p>
            <p>{{ subnivelActual.descripcion }}</p>
          </div>
        </div>

        <!-- Contenido (Tablas, ImÃ¡genes, GrÃ¡ficas, Collages) -->
        <ng-container *ngFor="let contenido of contenidoOrdenado; let i = index">
          
          <!-- Archivo Excel - Una o mÃºltiples tablas -->
          <ng-container *ngIf="contenido.tipo === 'excel'">
            <!-- Si es un archivo con mÃºltiples tablas -->
            <ng-container *ngIf="contenido.item.esMultiTabla && contenido.item.tablas">
              <div *ngFor="let tabla of contenido.item.tablas; let tablaIndex = index" 
                   [class.masonry-item-large]="esTablaGrande({datos: tabla.datos})"
                   [class.masonry-item-small]="!esTablaGrande({datos: tabla.datos})"
                   class="masonry-item">
                <div class="card card-table multi-table-card" 
                     [class.is-small-table]="!esTablaGrande({datos: tabla.datos})"
                     [attr.data-columns]="tabla.datos[0]?.length">
                  <div class="card-header table-header">
                    <div class="table-info">
                      <h3 class="table-title">
                        {{tabla.titulo}}
                        <span class="multi-table-badge">Tabla {{tablaIndex + 1}}/{{contenido.item.tablas!.length}}</span>
                      </h3>
                      <div class="table-meta">
                        <span class="meta-item">
                          <mat-icon class="meta-icon">description</mat-icon>
                          {{contenido.item.tituloPersonalizado || contenido.item.nombre}}
                        </span>
                        <span class="meta-item">
                          <mat-icon class="meta-icon">table_rows</mat-icon>
                          {{tabla.datos.length - 1}} filas
                        </span>
                        <span class="meta-item">
                          <mat-icon class="meta-icon">view_column</mat-icon>
                          {{tabla.datos[0]?.length}} columnas
                        </span>
                      </div>
                    </div>
                    <div class="button-group">
                      <button type="button" (click)="expandirTablaIndividual(contenido.index, tablaIndex)"
                              class="btn-table-action btn-expand"
                              matTooltip="Expandir tabla en ventana completa"
                              matTooltipPosition="above">
                        <mat-icon>fullscreen</mat-icon>
                      </button>
                      <button type="button" (click)="abrirModalGraficaTabla(contenido.index, tablaIndex)"
                              class="btn-table-action btn-chart"
                              matTooltip="Crear grÃ¡fica a partir de esta tabla"
                              matTooltipPosition="above">
                        <mat-icon>bar_chart</mat-icon>
                      </button>
                      <button type="button" (click)="actualizarArchivoExcel(contenido.index)"
                              class="btn-table-action btn-update"
                              matTooltip="Actualizar archivo Excel completo"
                              matTooltipPosition="above">
                        <mat-icon>refresh</mat-icon>
                      </button>
                      <button type="button" (click)="eliminarTablaIndividual(contenido.index, tablaIndex)"
                              class="btn-table-action btn-delete"
                              matTooltip="Eliminar solo esta tabla"
                              matTooltipPosition="above">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>

                  <div class="table-container professional-table">
                    <table class="data-table modern-table">
                      <thead>
                        <tr>
                          <th *ngFor="let header of tabla.datos[0]; let i = index" 
                              [class.sortable]="true"
                              class="table-header-cell">
                            <div class="header-content">
                              <span class="header-text">{{header}}</span>
                              <mat-icon class="sort-icon">unfold_more</mat-icon>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let fila of tabla.datos.slice(1); let rowIndex = index" 
                            class="table-row"
                            [class.even]="rowIndex % 2 === 0">
                          <td *ngFor="let celda of fila; let colIndex = index" 
                              class="table-cell"
                              [class.numeric]="isNumeric(celda)">
                            {{formatCellData(celda)}}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </ng-container>
            
            <!-- Si es un archivo con tabla Ãºnica (compatibilidad hacia atrÃ¡s) -->
            <div *ngIf="!contenido.item.esMultiTabla" 
                 [class.masonry-item-large]="esTablaGrande(contenido.item)"
                 [class.masonry-item-small]="!esTablaGrande(contenido.item)"
                 class="masonry-item">
              <div class="card card-table" 
                   [class.is-small-table]="!esTablaGrande(contenido.item)"
                   [attr.data-columns]="contenido.item.datos[0]?.length">
                <div class="card-header table-header">
                  <div class="table-info">
                    <h3 class="table-title">{{contenido.item.tituloPersonalizado || contenido.item.nombre}}</h3>
                    <div class="table-meta">
                      <span class="meta-item">
                        <mat-icon class="meta-icon">table_rows</mat-icon>
                        {{contenido.item.datos.length - 1}} filas
                      </span>
                      <span class="meta-item">
                        <mat-icon class="meta-icon">view_column</mat-icon>
                        {{contenido.item.datos[0]?.length}} columnas
                      </span>
                    </div>
                  </div>
                  <div class="button-group">
                    <button type="button" (click)="expandirTabla(contenido.index)"
                            class="btn-table-action btn-expand"
                            matTooltip="Expandir tabla en ventana completa"
                            matTooltipPosition="above">
                      <mat-icon>fullscreen</mat-icon>
                    </button>
                    <button type="button" (click)="abrirModalGrafica(contenido.index)"
                            class="btn-table-action btn-chart"
                            matTooltip="Crear grÃ¡fica a partir de estos datos"
                            matTooltipPosition="above">
                      <mat-icon>bar_chart</mat-icon>
                    </button>
                    <button type="button" (click)="actualizarArchivoExcel(contenido.index)"
                            class="btn-table-action btn-update"
                            matTooltip="Actualizar con nuevo archivo Excel"
                            matTooltipPosition="above">
                      <mat-icon>refresh</mat-icon>
                    </button>
                    <button type="button" (click)="eliminarExcel(contenido.index)"
                            class="btn-table-action btn-delete"
                            matTooltip="Eliminar esta tabla"
                            matTooltipPosition="above">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>

                <div class="table-container professional-table">
                  <table class="data-table modern-table">
                    <thead>
                      <tr>
                        <th *ngFor="let header of contenido.item.datos[0]; let i = index" 
                            [class.sortable]="true"
                            class="table-header-cell">
                          <div class="header-content">
                            <span class="header-text">{{header}}</span>
                            <mat-icon class="sort-icon">unfold_more</mat-icon>
                          </div>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let fila of contenido.item.datos.slice(1); let rowIndex = index" 
                          class="table-row"
                          [class.even]="rowIndex % 2 === 0">
                        <td *ngFor="let celda of fila; let colIndex = index" 
                            class="table-cell"
                            [class.numeric]="isNumeric(celda)">
                          {{formatCellData(celda)}}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Imagen (ocupan 1 columna) -->
          <div *ngIf="contenido.tipo === 'imagen'" class="masonry-item masonry-item-small">
            <div class="card card-image professional-image">
              <div class="image-header">
                <div class="image-info">
                  <h3 class="image-title">{{contenido.item.tituloPersonalizado || contenido.item.nombre}}</h3>
                  <div class="image-meta">
                    <span class="meta-item">
                      <mat-icon class="meta-icon">photo</mat-icon>
                      Imagen
                    </span>
                    <span class="meta-item" *ngIf="getImageSize(contenido.item)">
                      <mat-icon class="meta-icon">aspect_ratio</mat-icon>
                      {{getImageSize(contenido.item)}}
                    </span>
                  </div>
                </div>
                <div class="image-actions">
                  <button type="button" 
                          class="btn-image-action btn-fullscreen"
                          matTooltip="Ver en pantalla completa"
                          matTooltipPosition="above"
                          (click)="expandirImagen(contenido.item)">
                    <mat-icon>fullscreen</mat-icon>
                  </button>
                  <button type="button" 
                          class="btn-image-action btn-download"
                          matTooltip="Descargar imagen"
                          matTooltipPosition="above"
                          (click)="downloadImage(contenido.item)">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button type="button" 
                          class="btn-image-action btn-delete"
                          matTooltip="Eliminar imagen"
                          matTooltipPosition="above"
                          (click)="eliminarImagen(contenido.index)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <div class="image-container modern-image-container">
                <div class="image-wrapper">
                  <img [src]="contenido.item.datos" 
                       [alt]="contenido.item.tituloPersonalizado || contenido.item.nombre"
                       class="image-display modern-image"
                       (click)="expandirImagen(contenido.item)"
                       (load)="onImageLoad($event, contenido.item)">
                  <div class="image-overlay">
                    <mat-icon class="zoom-icon">zoom_in</mat-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Collage (ocupan 1 o 2 columnas segÃºn cantidad de imÃ¡genes) -->
          <div *ngIf="contenido.tipo === 'collage'" 
               [class.masonry-item-small]="contenido.item.imagenes.length < 4"
               [class.masonry-item-large]="contenido.item.imagenes.length >= 4"
               class="masonry-item">
            <div class="card card-collage professional-collage">
              <div class="collage-header">
                <div class="collage-info">
                  <h3 class="collage-title">{{contenido.item.titulo}}</h3>
                  <div class="collage-meta">
                    <span class="meta-item">
                      <mat-icon class="meta-icon">collections</mat-icon>
                      Collage
                    </span>
                    <span class="meta-item">
                      <mat-icon class="meta-icon">photo_library</mat-icon>
                      {{contenido.item.imagenes.length}} imÃ¡genes
                    </span>
                  </div>
                </div>
                <!--
                <button type="button" 
                    class="btn-collage-action btn-slideshow"
                    matTooltip="Ver presentaciÃ³n"
                    matTooltipPosition="above"
                    (click)="startSlideshow(contenido.item)">
                    <mat-icon>slideshow</mat-icon>
                </button>
                -->
                <div class="collage-actions">
                  <button type="button" 
                          class="btn-collage-action btn-download-all"
                          matTooltip="Descargar todas"
                          matTooltipPosition="above"
                          (click)="downloadAllImages(contenido.item)">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button type="button" 
                          class="btn-collage-action btn-delete"
                          matTooltip="Eliminar collage"
                          matTooltipPosition="above"
                          (click)="eliminarCollage(contenido.index)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <div class="collage-container modern-collage-container">
                <div class="collage-grid modern-grid" 
                     [class.grid-2]="contenido.item.imagenes.length === 2"
                     [class.grid-3]="contenido.item.imagenes.length === 3"
                     [class.grid-4-plus]="contenido.item.imagenes.length >= 4">
                  <div *ngFor="let imagen of contenido.item.imagenes; let i = index" 
                       class="collage-item modern-collage-item"
                       [class.featured]="i === 0 && contenido.item.imagenes.length > 2">
                    <div class="collage-image-wrapper" 
                         (click)="expandirImagen(imagen)"
                         [title]="'Hacer clic para ver ' + imagen.nombre">
                      <img [src]="imagen.datos" 
                           [alt]="imagen.nombre"
                           class="collage-image">
                      <div class="collage-overlay">
                        <mat-icon class="collage-zoom-icon">zoom_in</mat-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- GrÃ¡fica (1 o 2 columnas segÃºn tamaÃ±o) -->
          <div *ngIf="contenido.tipo === 'grafica'" 
               [class.masonry-item-large]="esGraficaGrande(contenido.item)"
               [class.masonry-item-small]="!esGraficaGrande(contenido.item)"
               class="masonry-item">
            <div class="card-chart-wrapper">
              <app-grafica-viewer [grafica]="contenido.item"
                                  [index]="contenido.index"
                                  (onEliminar)="eliminarGrafica($event)"
                                  (onExpandir)="expandirGrafica($event)">
              </app-grafica-viewer>
            </div>
          </div>
        </ng-container>

        <!-- Tarjetas de Texto -->
        <ng-container *ngFor="let contenido of contenidoOrdenado">
          <div *ngIf="contenido.tipo === 'texto'" class="masonry-item masonry-item-small">
            <div class="card card-text">
              <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-800">{{contenido.item.titulo}}</h3>
                <button type="button" (click)="eliminarTarjetaTexto(contenido.index)"
                        class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                  âœ•
                </button>
              </div>
              <div class="card-content">
                <p class="text-gray-700 text-sm whitespace-pre-wrap">{{contenido.item.contenido}}</p>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Mensaje cuando no hay subnivel seleccionado -->
    <div *ngIf="!subnivelActual" class="flex items-center justify-center h-full">
      <div class="text-center text-gray-500">
        <p class="text-2xl mb-2">ðŸ“„</p>
        <p class="text-lg font-semibold">Seleccione un subnivel para comenzar</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Imagen Expandida -->
<div *ngIf="imagenExpandida" class="modal-backdrop modern-modal-backdrop" (click)="imagenExpandida = null">
  <div class="modal-imagen-grande modern-image-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <mat-icon class="modal-icon">photo</mat-icon>
        <span>{{imagenExpandida.tituloPersonalizado || imagenExpandida.nombre}}</span>
      </div>
      <div class="modal-actions">
        <button type="button" 
                class="btn-modal-action btn-download-modal"
                matTooltip="Descargar imagen"
                (click)="downloadImage(imagenExpandida)">
          <mat-icon>download</mat-icon>
        </button>
        <button type="button" 
                class="btn-modal-action btn-close-modal"
                matTooltip="Cerrar"
                (click)="imagenExpandida = null">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <div class="modal-content">
      <img [src]="imagenExpandida.datos" 
           [alt]="imagenExpandida.nombre" 
           class="imagen-grande modern-expanded-image">
    </div>
  </div>
</div>

<!-- Modal de GrÃ¡fica -->
<app-modal-grafica *ngIf="mostrarModalGrafica && archivoExcelTemporal"
                   [excel]="archivoExcelTemporal"
                   [excelIndex]="excelIndexSeleccionado"
                   (onCrear)="crearGrafica($event)"
                   (onCerrar)="cerrarModalGrafica()">
</app-modal-grafica>

<!-- Modal de Tabla Expandida -->
<div *ngIf="mostrarModalTabla" 
     class="table-modal-backdrop" 
     (click)="cerrarModalTabla()">
  <div class="table-modal-container" 
       (click)="$event.stopPropagation()">
    <!-- Header del Modal -->
    <div class="table-modal-header">
      <div class="modal-title-section">
        <mat-icon class="modal-icon">table_view</mat-icon>
        <div class="title-info">
          <h2 class="modal-title">{{tablaExpandida?.tituloPersonalizado || tablaExpandida?.nombre}}</h2>
          <span class="modal-subtitle">
            {{tablaExpandida?.datos.length - 1}} filas Ã— {{tablaExpandida?.datos[0]?.length}} columnas
          </span>
        </div>
      </div>
      <div class="modal-header-actions">
        <button type="button" 
                class="modal-action-btn"
                matTooltip="Descargar CSV"
                (click)="descargarCSV()">
          <mat-icon>download</mat-icon>
        </button>
        <button type="button" 
                class="modal-action-btn"
                matTooltip="Imprimir tabla"
                (click)="imprimirTabla()">
          <mat-icon>print</mat-icon>
        </button>
        <button type="button" 
                class="modal-action-btn close-btn"
                matTooltip="Cerrar"
                (click)="cerrarModalTabla()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    
    <!-- Contenido del Modal -->
    <div class="table-modal-content">
      <div class="table-wrapper">
        <table class="expanded-table">
          <thead>
            <tr>
              <th *ngFor="let header of tablaExpandida?.datos[0]; let i = index"
                  class="table-header-cell"
                  [class.sortable]="true"
                  (click)="ordenarColumna(i)">
                <div class="header-content">
                  <span class="header-text">{{header}}</span>
                  <mat-icon class="sort-icon" 
                           *ngIf="columnaOrdenada === i">
                    {{ordenAscendente ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}
                  </mat-icon>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fila of datosOrdenados; let rowIndex = index" 
                class="table-row"
                [class.even]="rowIndex % 2 === 0">
              <td *ngFor="let celda of fila; let colIndex = index" 
                  class="table-cell"
                  [class.numeric]="esNumerico(celda)"
                  [class.highlight]="columnaOrdenada === colIndex">
                <span class="cell-content">{{formatearCelda(celda)}}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Footer del Modal -->
    <div class="table-modal-footer">
      <div class="footer-stats">
        <div class="stat-item">
          <mat-icon class="stat-icon">table_rows</mat-icon>
          <span class="stat-label">Filas:</span>
          <span class="stat-value">{{tablaExpandida?.datos.length - 1}}</span>
        </div>
        <div class="stat-item">
          <mat-icon class="stat-icon">view_column</mat-icon>
          <span class="stat-label">Columnas:</span>
          <span class="stat-value">{{tablaExpandida?.datos[0]?.length}}</span>
        </div>
        <div class="stat-item">
          <mat-icon class="stat-icon">data_usage</mat-icon>
          <span class="stat-label">Celdas:</span>
          <span class="stat-value">{{(tablaExpandida?.datos.length - 1) * tablaExpandida?.datos[0]?.length}}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de GrÃ¡fica Expandida -->
<div *ngIf="mostrarModalGraficaExpandida" 
     class="chart-modal-backdrop" 
     (click)="cerrarModalGraficaExpandida()">
  <div class="chart-modal-container" 
       (click)="$event.stopPropagation()">
    <!-- Header del Modal -->
    <div class="chart-modal-header">
      <div class="modal-title-section">
        <mat-icon class="modal-icon">analytics</mat-icon>
        <div class="title-info">
          <h2 class="modal-title">{{graficaExpandida?.tituloPersonalizado || ('GrÃ¡fica de ' + graficaExpandida?.nombreExcel)}}</h2>
          <span class="modal-subtitle">
            {{graficaExpandida?.datos?.length || 0}} datos â€¢ 
            {{graficaExpandida?.columnas?.length || 0}} series â€¢ 
            {{getChartTypeName(graficaExpandida?.tipo)}}
          </span>
        </div>
      </div>
      <div class="modal-header-actions">
        <button type="button" 
                class="modal-action-btn close-btn"
                matTooltip="Cerrar"
                (click)="cerrarModalGraficaExpandida()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    
    <!-- Contenido del Modal -->
    <div class="chart-modal-content">
      <div class="chart-expanded-wrapper">
        <app-grafica-viewer *ngIf="graficaExpandida"
                            [grafica]="graficaExpandida"
                            [index]="graficaExpandidaIndex"
                            (onEliminar)="eliminarGrafica($event); cerrarModalGraficaExpandida()">
        </app-grafica-viewer>
      </div>
    </div>
  </div>
</div>

</div>
